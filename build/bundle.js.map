{"version":3,"file":"bundle.js","sources":["../src/index.ts"],"sourcesContent":["import { MessageBot, Player } from '@bhmb/bot'\r\nimport { UIExtensionExports } from '@bhmb/ui'\r\n\r\nimport html from './tab.html'\r\n\r\ninterface Settings {\r\n  onSet: string\r\n  onClear: string\r\n  onTrigger: string\r\n}\r\n\r\nMessageBot.registerExtension('bibliofile/afk', (ex, world) => {\r\n  const getSettings = (): Settings => Object.assign({\r\n    onSet: 'AFK Message set - Say anything in chat to remove it.',\r\n    onClear: 'Cleared {{Name}}\\'s AFK Message',\r\n    onTrigger: ' {{Away}} is AFK. Message: {{message}}',\r\n  }, ex.storage.get<Partial<Settings>>('settings', {}))\r\n\r\n  let triggers = new Map<string, string>()\r\n  function deleteTrigger(name: string) {\r\n    triggers.delete(name.toLocaleUpperCase())\r\n  }\r\n\r\n  world.addCommand('afk', (player, message) => {\r\n    triggers.set(player.name, message)\r\n    ex.bot.send(getSettings().onSet, { name: player.name })\r\n  })\r\n  world.addCommand('afkclear', (player, args) => {\r\n    if (player.isAdmin) {\r\n      deleteTrigger(args)\r\n      ex.bot.send(getSettings().onClear, { name: args})\r\n    }\r\n  })\r\n\r\n  function chatWatcher({player, message}: { player: Player, message: string}) {\r\n    if (player.name == 'SERVER') return\r\n    message = message.toLocaleUpperCase()\r\n\r\n    deleteTrigger(player.name)\r\n\r\n    for (let [name, afk] of triggers.entries()) {\r\n      if (message.includes(name)) {\r\n        ex.bot.send(getSettings().onTrigger, {\r\n          message: afk,\r\n          name: player.name,\r\n          Away: name[0] + name.substr(1).toLocaleLowerCase(),\r\n          away: name.toLocaleLowerCase(),\r\n          AWAY: name\r\n        })\r\n        return // Only one afk response per message to avoid spam\r\n      }\r\n    }\r\n  }\r\n\r\n  function leaveWatcher(player: Player) {\r\n    deleteTrigger(player.name)\r\n  }\r\n\r\n  world.onMessage.sub(chatWatcher)\r\n  world.onLeave.sub(leaveWatcher)\r\n\r\n  ex.remove = () => {\r\n    for (let command of ['afk', 'afkclear']) {\r\n      world.removeCommand(command)\r\n    }\r\n    world.onMessage.unsub(chatWatcher)\r\n    world.onLeave.unsub(leaveWatcher)\r\n  }\r\n\r\n  // Browser only\r\n  const ui = ex.bot.getExports('ui') as UIExtensionExports | undefined\r\n  if (!ui) return\r\n\r\n  let tab = ui.addTab('AFK Messages')\r\n  tab.innerHTML = html\r\n\r\n  for (let key of Object.keys(getSettings()) as Array<keyof Settings>) {\r\n    let value = getSettings()[key]\r\n    ;(tab.querySelector(`[data-setting=${key}]`) as HTMLInputElement).value = value;\r\n  }\r\n\r\n  tab.addEventListener('input', () => {\r\n    ex.storage.set('settings', {\r\n      onSet: (tab.querySelector('[data-setting=onSet]') as HTMLInputElement).value,\r\n      onClear: (tab.querySelector('[data-setting=onClear]') as HTMLInputElement).value,\r\n      onTrigger: (tab.querySelector('[data-setting=onTrigger]') as HTMLInputElement).value,\r\n    })\r\n  })\r\n\r\n  ex.remove = (function(orig) {\r\n    return () => {\r\n      orig()\r\n      ui.removeTab(tab)\r\n    }\r\n  }(ex.remove))\r\n})\r\n"],"names":["MessageBot"],"mappings":"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"}